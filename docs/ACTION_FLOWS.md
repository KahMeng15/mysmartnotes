# ğŸ”„ Action Flows

Complete user flows and system processes for MySmartNotes.

## Overview

This document details all user interactions and backend processes, showing the complete flow of data through the system.

---

## 1. User Registration & Authentication Flow

### 1.1 User Registration

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Client  â”‚                â”‚ API Gateway  â”‚               â”‚PostgreSQLâ”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜                â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜               â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
     â”‚                             â”‚                            â”‚
     â”‚ POST /auth/register         â”‚                            â”‚
     â”‚ {username, email, password} â”‚                            â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                            â”‚
     â”‚                             â”‚                            â”‚
     â”‚                             â”‚ Validate input             â”‚
     â”‚                             â”‚ Hash password              â”‚
     â”‚                             â”‚                            â”‚
     â”‚                             â”‚ INSERT user                â”‚
     â”‚                             â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
     â”‚                             â”‚                            â”‚
     â”‚                             â”‚ <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
     â”‚                             â”‚ User created (id=123)      â”‚
     â”‚                             â”‚                            â”‚
     â”‚                             â”‚ Generate JWT tokens        â”‚
     â”‚                             â”‚                            â”‚
     â”‚ <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                            â”‚
     â”‚ 201 Created                 â”‚                            â”‚
     â”‚ {access_token, refresh_token, user}                      â”‚
     â”‚                             â”‚                            â”‚
```

**Steps:**
1. Client sends registration data
2. API Gateway validates input (email format, password strength)
3. Password is hashed using bcrypt
4. User record created in PostgreSQL
5. JWT access token (15min) and refresh token (7 days) generated
6. Tokens returned to client
7. Client stores tokens in session/localStorage

### 1.2 User Login

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Client  â”‚                â”‚ API Gateway  â”‚               â”‚PostgreSQLâ”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜                â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜               â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
     â”‚                             â”‚                            â”‚
     â”‚ POST /auth/login            â”‚                            â”‚
     â”‚ {username, password}        â”‚                            â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                            â”‚
     â”‚                             â”‚                            â”‚
     â”‚                             â”‚ SELECT user WHERE username â”‚
     â”‚                             â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
     â”‚                             â”‚                            â”‚
     â”‚                             â”‚ <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
     â”‚                             â”‚ User record                â”‚
     â”‚                             â”‚                            â”‚
     â”‚                             â”‚ Verify password hash       â”‚
     â”‚                             â”‚                            â”‚
     â”‚                             â”‚ UPDATE last_login          â”‚
     â”‚                             â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
     â”‚                             â”‚                            â”‚
     â”‚                             â”‚ Generate JWT tokens        â”‚
     â”‚                             â”‚                            â”‚
     â”‚ <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                            â”‚
     â”‚ 200 OK                      â”‚                            â”‚
     â”‚ {access_token, refresh_token, user}                      â”‚
     â”‚                             â”‚                            â”‚
```

---

## 2. Subject & Lecture Management Flow

### 2.1 Create Subject

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”
â”‚ Client  â”‚     â”‚ API Gateway  â”‚     â”‚PostgreSQLâ”‚     â”‚Redisâ”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”¬â”€â”€â”˜
     â”‚                  â”‚                  â”‚               â”‚
     â”‚ POST /subjects   â”‚                  â”‚               â”‚
     â”‚ {name, color}    â”‚                  â”‚               â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                  â”‚               â”‚
     â”‚  + JWT Token     â”‚                  â”‚               â”‚
     â”‚                  â”‚                  â”‚               â”‚
     â”‚                  â”‚ Verify JWT       â”‚               â”‚
     â”‚                  â”‚                  â”‚               â”‚
     â”‚                  â”‚ INSERT subject   â”‚               â”‚
     â”‚                  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚               â”‚
     â”‚                  â”‚                  â”‚               â”‚
     â”‚                  â”‚ <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤               â”‚
     â”‚                  â”‚ Subject created  â”‚               â”‚
     â”‚                  â”‚                  â”‚               â”‚
     â”‚                  â”‚ Cache invalidate â”‚               â”‚
     â”‚                  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
     â”‚                  â”‚ DEL user:123:subjects            â”‚
     â”‚                  â”‚                  â”‚               â”‚
     â”‚ <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                  â”‚               â”‚
     â”‚ 201 Created      â”‚                  â”‚               â”‚
     â”‚ {subject}        â”‚                  â”‚               â”‚
     â”‚                  â”‚                  â”‚               â”‚
```

### 2.2 List Subjects

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”
â”‚ Client  â”‚     â”‚ API Gateway  â”‚     â”‚PostgreSQLâ”‚     â”‚Redisâ”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”¬â”€â”€â”˜
     â”‚                  â”‚                  â”‚               â”‚
     â”‚ GET /subjects    â”‚                  â”‚               â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                  â”‚               â”‚
     â”‚  + JWT Token     â”‚                  â”‚               â”‚
     â”‚                  â”‚                  â”‚               â”‚
     â”‚                  â”‚ Verify JWT       â”‚               â”‚
     â”‚                  â”‚                  â”‚               â”‚
     â”‚                  â”‚ Check cache      â”‚               â”‚
     â”‚                  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
     â”‚                  â”‚ GET user:123:subjects            â”‚
     â”‚                  â”‚                  â”‚               â”‚
     â”‚                  â”‚ <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚                  â”‚ Cache MISS       â”‚               â”‚
     â”‚                  â”‚                  â”‚               â”‚
     â”‚                  â”‚ SELECT subjects  â”‚               â”‚
     â”‚                  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚               â”‚
     â”‚                  â”‚                  â”‚               â”‚
     â”‚                  â”‚ <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤               â”‚
     â”‚                  â”‚ Subjects list    â”‚               â”‚
     â”‚                  â”‚                  â”‚               â”‚
     â”‚                  â”‚ Cache subjects   â”‚               â”‚
     â”‚                  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
     â”‚                  â”‚ SET user:123:subjects TTL=1800   â”‚
     â”‚                  â”‚                  â”‚               â”‚
     â”‚ <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                  â”‚               â”‚
     â”‚ 200 OK           â”‚                  â”‚               â”‚
     â”‚ [{subjects}]     â”‚                  â”‚               â”‚
     â”‚                  â”‚                  â”‚               â”‚
```

---

## 3. Lecture Upload & Processing Flow

### 3.1 Upload Lecture File

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Client â”‚  â”‚API Gatewayâ”‚  â”‚PostgreSQLâ”‚  â”‚Redisâ”‚  â”‚  Celery  â”‚  â”‚ Worker â”‚
â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”¬â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
    â”‚              â”‚             â”‚            â”‚          â”‚             â”‚
    â”‚ POST /lectures/upload     â”‚            â”‚          â”‚             â”‚
    â”‚ {name, subject_id, file}  â”‚            â”‚          â”‚             â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚             â”‚            â”‚          â”‚             â”‚
    â”‚              â”‚             â”‚            â”‚          â”‚             â”‚
    â”‚              â”‚ Validate file (size, type)         â”‚             â”‚
    â”‚              â”‚             â”‚            â”‚          â”‚             â”‚
    â”‚              â”‚ Save to /data/uploads/123/456/     â”‚             â”‚
    â”‚              â”‚             â”‚            â”‚          â”‚             â”‚
    â”‚              â”‚ INSERT lecture (status=pending)    â”‚             â”‚
    â”‚              â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚            â”‚          â”‚             â”‚
    â”‚              â”‚             â”‚            â”‚          â”‚             â”‚
    â”‚              â”‚ <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤            â”‚          â”‚             â”‚
    â”‚              â”‚ Lecture created (id=456) â”‚          â”‚             â”‚
    â”‚              â”‚             â”‚            â”‚          â”‚             â”‚
    â”‚              â”‚ Queue OCR task           â”‚          â”‚             â”‚
    â”‚              â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚          â”‚             â”‚
    â”‚              â”‚ apply_async(process_lecture, 456)  â”‚             â”‚
    â”‚              â”‚             â”‚            â”‚          â”‚             â”‚
    â”‚              â”‚             â”‚            â”‚ â”€â”€â”€â”€â”€â”€â”€â”€>â”‚             â”‚
    â”‚              â”‚             â”‚            â”‚ Task queued            â”‚
    â”‚              â”‚             â”‚            â”‚          â”‚             â”‚
    â”‚ <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤             â”‚            â”‚          â”‚             â”‚
    â”‚ 202 Accepted â”‚             â”‚            â”‚          â”‚             â”‚
    â”‚ {task_id, lecture_id}     â”‚            â”‚          â”‚             â”‚
    â”‚              â”‚             â”‚            â”‚          â”‚             â”‚
    â”‚              â”‚             â”‚            â”‚  Worker picks task     â”‚
    â”‚              â”‚             â”‚            â”‚          â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
    â”‚              â”‚             â”‚            â”‚          â”‚             â”‚
```

### 3.2 OCR Processing (Worker)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Client â”‚  â”‚PostgreSQLâ”‚  â”‚ChromaDBâ”‚  â”‚Redisâ”‚  â”‚WebSocket â”‚  â”‚ Worker â”‚
â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜  â””â”€â”€â”¬â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
    â”‚             â”‚             â”‚          â”‚          â”‚             â”‚
    â”‚             â”‚             â”‚          â”‚          â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”
    â”‚             â”‚             â”‚          â”‚          â”‚    â”‚ Start OCR Taskâ”‚
    â”‚             â”‚             â”‚          â”‚          â”‚    â”‚               â”‚
    â”‚             â”‚             â”‚          â”‚          â”‚    â”‚ 1. Load PDF   â”‚
    â”‚             â”‚             â”‚          â”‚          â”‚    â”‚ 2. Convert to â”‚
    â”‚             â”‚             â”‚          â”‚          â”‚    â”‚    images     â”‚
    â”‚             â”‚             â”‚          â”‚          â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
    â”‚             â”‚             â”‚          â”‚          â”‚             â”‚
    â”‚             â”‚ UPDATE lecture status=processing  â”‚             â”‚
    â”‚             â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚             â”‚             â”‚          â”‚          â”‚             â”‚
    â”‚             â”‚             â”‚          â”‚ Publish progress       â”‚
    â”‚             â”‚             â”‚          â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚             â”‚             â”‚          â”‚ {page: 1/20, status}   â”‚
    â”‚             â”‚             â”‚          â”‚          â”‚             â”‚
    â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚ WebSocket: Progress 5%   â”‚          â”‚          â”‚             â”‚
    â”‚             â”‚             â”‚          â”‚          â”‚             â”‚
    â”‚             â”‚             â”‚          â”‚          â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”
    â”‚             â”‚             â”‚          â”‚          â”‚    â”‚ For each page:â”‚
    â”‚             â”‚             â”‚          â”‚          â”‚    â”‚               â”‚
    â”‚             â”‚             â”‚          â”‚          â”‚    â”‚ 3. LayoutParserâ”‚
    â”‚             â”‚             â”‚          â”‚          â”‚    â”‚ 4. Crop figuresâ”‚
    â”‚             â”‚             â”‚          â”‚          â”‚    â”‚ 5. OCR text   â”‚
    â”‚             â”‚             â”‚          â”‚          â”‚    â”‚ 6. Clean text â”‚
    â”‚             â”‚             â”‚          â”‚          â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
    â”‚             â”‚             â”‚          â”‚          â”‚             â”‚
    â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚ WebSocket: Progress 50%  â”‚          â”‚          â”‚             â”‚
    â”‚             â”‚             â”‚          â”‚          â”‚             â”‚
    â”‚             â”‚             â”‚          â”‚          â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”
    â”‚             â”‚             â”‚          â”‚          â”‚    â”‚ 7. Generate   â”‚
    â”‚             â”‚             â”‚          â”‚          â”‚    â”‚    embeddings â”‚
    â”‚             â”‚             â”‚          â”‚          â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
    â”‚             â”‚             â”‚          â”‚          â”‚             â”‚
    â”‚             â”‚             â”‚ Insert embeddings   â”‚             â”‚
    â”‚             â”‚             â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚             â”‚             â”‚ collection.add({chunks})         â”‚
    â”‚             â”‚             â”‚          â”‚          â”‚             â”‚
    â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚ WebSocket: Progress 90%  â”‚          â”‚          â”‚             â”‚
    â”‚             â”‚             â”‚          â”‚          â”‚             â”‚
    â”‚             â”‚ UPDATE lecture status=completed   â”‚             â”‚
    â”‚             â”‚ page_count=20, processed_at=NOW   â”‚             â”‚
    â”‚             â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚             â”‚             â”‚          â”‚          â”‚             â”‚
    â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚ WebSocket: Complete 100% â”‚          â”‚          â”‚             â”‚
    â”‚             â”‚             â”‚          â”‚          â”‚             â”‚
```

**Detailed Steps:**

1. **Load PDF** - Worker reads file from `/data/uploads/123/456/original.pdf`
2. **Convert to Images** - Each page converted to 300 DPI PNG image
3. **Layout Detection** - LayoutParser detects figure vs text regions
4. **Crop Figures** - Figures saved as `slide_01_fig_01.png`
5. **OCR Text** - Tesseract extracts text from non-figure regions
6. **Clean Text** - Remove headers, footers, slide numbers
7. **Chunk Text** - Split into ~500 token chunks with overlap
8. **Generate Embeddings** - Ollama creates vector embeddings
9. **Store in ChromaDB** - Embeddings stored with metadata
10. **Update Database** - Lecture status changed to 'completed'
11. **Notify Client** - WebSocket sends completion message

---

## 4. Chat & RAG Query Flow

### 4.1 Chat Query

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Client â”‚  â”‚API Gatewayâ”‚  â”‚ChromaDBâ”‚  â”‚Redisâ”‚  â”‚Ollamaâ”‚  â”‚DuckDuckGoâ”‚
â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜  â””â”€â”€â”¬â”€â”€â”˜  â””â”€â”€â”¬â”€â”€â”€â”˜  â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
    â”‚              â”‚             â”‚          â”‚        â”‚          â”‚
    â”‚ WebSocket: chat_query      â”‚          â”‚        â”‚          â”‚
    â”‚ {message, lecture_id, use_web}        â”‚        â”‚          â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚             â”‚          â”‚        â”‚          â”‚
    â”‚              â”‚             â”‚          â”‚        â”‚          â”‚
    â”‚              â”‚ Check cache â”‚          â”‚        â”‚          â”‚
    â”‚              â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚        â”‚          â”‚
    â”‚              â”‚ GET query:{hash}       â”‚        â”‚          â”‚
    â”‚              â”‚             â”‚          â”‚        â”‚          â”‚
    â”‚              â”‚ <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤        â”‚          â”‚
    â”‚              â”‚ Cache MISS  â”‚          â”‚        â”‚          â”‚
    â”‚              â”‚             â”‚          â”‚        â”‚          â”‚
    â”‚              â”‚ Generate query embeddingâ”‚        â”‚          â”‚
    â”‚              â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚          â”‚
    â”‚              â”‚             â”‚          â”‚        â”‚          â”‚
    â”‚              â”‚ <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤          â”‚
    â”‚              â”‚ Query vector            â”‚        â”‚          â”‚
    â”‚              â”‚             â”‚          â”‚        â”‚          â”‚
    â”‚              â”‚ Search similar chunks   â”‚        â”‚          â”‚
    â”‚              â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚          â”‚        â”‚          â”‚
    â”‚              â”‚ collection.query(vector, n=5)   â”‚          â”‚
    â”‚              â”‚             â”‚          â”‚        â”‚          â”‚
    â”‚              â”‚ <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤          â”‚        â”‚          â”‚
    â”‚              â”‚ Top 5 chunksâ”‚          â”‚        â”‚          â”‚
    â”‚              â”‚             â”‚          â”‚        â”‚          â”‚
    â”‚              â”‚ IF use_web_search: search web   â”‚          â”‚
    â”‚              â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
    â”‚              â”‚             â”‚          â”‚        â”‚          â”‚
    â”‚              â”‚ <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚              â”‚ Web results â”‚          â”‚        â”‚          â”‚
    â”‚              â”‚             â”‚          â”‚        â”‚          â”‚
    â”‚              â”‚ Format context          â”‚        â”‚          â”‚
    â”‚              â”‚             â”‚          â”‚        â”‚          â”‚
    â”‚              â”‚ Stream LLM response     â”‚        â”‚          â”‚
    â”‚              â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚          â”‚
    â”‚              â”‚ Prompt + context       â”‚        â”‚          â”‚
    â”‚              â”‚             â”‚          â”‚        â”‚          â”‚
    â”‚              â”‚ <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤          â”‚
    â”‚              â”‚ Response chunk 1       â”‚        â”‚          â”‚
    â”‚              â”‚             â”‚          â”‚        â”‚          â”‚
    â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤             â”‚          â”‚        â”‚          â”‚
    â”‚ WS: {chunk}  â”‚             â”‚          â”‚        â”‚          â”‚
    â”‚              â”‚             â”‚          â”‚        â”‚          â”‚
    â”‚              â”‚ <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤          â”‚
    â”‚              â”‚ Response chunk 2       â”‚        â”‚          â”‚
    â”‚              â”‚             â”‚          â”‚        â”‚          â”‚
    â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤             â”‚          â”‚        â”‚          â”‚
    â”‚ WS: {chunk}  â”‚             â”‚          â”‚        â”‚          â”‚
    â”‚              â”‚             â”‚          â”‚        â”‚          â”‚
    â”‚              â”‚ ... streaming continues ...    â”‚          â”‚
    â”‚              â”‚             â”‚          â”‚        â”‚          â”‚
    â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤             â”‚          â”‚        â”‚          â”‚
    â”‚ WS: complete â”‚             â”‚          â”‚        â”‚          â”‚
    â”‚              â”‚             â”‚          â”‚        â”‚          â”‚
    â”‚              â”‚ Cache response          â”‚        â”‚          â”‚
    â”‚              â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚        â”‚          â”‚
    â”‚              â”‚ SET query:{hash} TTL=1800        â”‚          â”‚
    â”‚              â”‚             â”‚          â”‚        â”‚          â”‚
```

**Steps:**

1. Client sends query via WebSocket
2. API Gateway checks Redis cache for similar query
3. If cache miss, generate embedding for query using Ollama
4. Search ChromaDB for top 5 similar chunks (filtered by lecture_id)
5. Optionally search web using DuckDuckGo API
6. Format context from chunks + web results
7. Stream response from Ollama LLM to client
8. Cache complete response in Redis

---

## 5. Document Generation Flow

### 5.1 Generate Cheat Sheet

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Client â”‚  â”‚API Gatewayâ”‚  â”‚PostgreSQLâ”‚  â”‚Redisâ”‚  â”‚ Celery â”‚  â”‚ Worker â”‚
â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”¬â”€â”€â”˜  â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
    â”‚              â”‚             â”‚            â”‚         â”‚            â”‚
    â”‚ POST /documents/generate   â”‚            â”‚         â”‚            â”‚
    â”‚ {lecture_id, doc_type=cheat_sheet}     â”‚         â”‚            â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚             â”‚            â”‚         â”‚            â”‚
    â”‚              â”‚             â”‚            â”‚         â”‚            â”‚
    â”‚              â”‚ Queue generation task    â”‚         â”‚            â”‚
    â”‚              â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚         â”‚            â”‚
    â”‚              â”‚             â”‚            â”‚         â”‚            â”‚
    â”‚              â”‚             â”‚            â”‚  â”€â”€â”€â”€â”€â”€>â”‚            â”‚
    â”‚              â”‚             â”‚            â”‚  Task queued          â”‚
    â”‚              â”‚             â”‚            â”‚         â”‚            â”‚
    â”‚ <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤             â”‚            â”‚         â”‚            â”‚
    â”‚ 202 Accepted â”‚             â”‚            â”‚         â”‚            â”‚
    â”‚ {task_id}    â”‚             â”‚            â”‚         â”‚            â”‚
    â”‚              â”‚             â”‚            â”‚         â”‚            â”‚
    â”‚              â”‚             â”‚            â”‚  Worker picks task   â”‚
    â”‚              â”‚             â”‚            â”‚         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
    â”‚              â”‚             â”‚            â”‚         â”‚            â”‚
    â”‚              â”‚             â”‚            â”‚         â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”
    â”‚              â”‚             â”‚            â”‚         â”‚   â”‚ 1. Query DB   â”‚
    â”‚              â”‚             â”‚            â”‚         â”‚   â”‚    for lectureâ”‚
    â”‚              â”‚             â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚              â”‚             â”‚            â”‚         â”‚   â”‚               â”‚
    â”‚              â”‚             â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>
    â”‚              â”‚             â”‚ Lecture data       â”‚ â”‚   â”‚               â”‚
    â”‚              â”‚             â”‚            â”‚         â”‚   â”‚ 2. Query      â”‚
    â”‚              â”‚             â”‚            â”‚         â”‚   â”‚    ChromaDB   â”‚
    â”‚              â”‚             â”‚            â”‚         â”‚   â”‚ 3. Load figuresâ”‚
    â”‚              â”‚             â”‚            â”‚         â”‚   â”‚ 4. Generate   â”‚
    â”‚              â”‚             â”‚            â”‚         â”‚   â”‚    Word doc   â”‚
    â”‚              â”‚             â”‚            â”‚         â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
    â”‚              â”‚             â”‚            â”‚         â”‚            â”‚
    â”‚              â”‚             â”‚            â”‚  Publish progress     â”‚
    â”‚              â”‚             â”‚            â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚              â”‚             â”‚            â”‚  {progress: 50%}     â”‚
    â”‚              â”‚             â”‚            â”‚         â”‚            â”‚
    â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚ WebSocket: Progress 50%   â”‚            â”‚         â”‚            â”‚
    â”‚              â”‚             â”‚            â”‚         â”‚            â”‚
    â”‚              â”‚             â”‚            â”‚         â”‚   Save document   â”‚
    â”‚              â”‚             â”‚            â”‚         â”‚   /data/generated/â”‚
    â”‚              â”‚             â”‚            â”‚         â”‚            â”‚
    â”‚              â”‚ INSERT generated_documentâ”‚         â”‚            â”‚
    â”‚              â”‚             â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚              â”‚             â”‚            â”‚         â”‚            â”‚
    â”‚              â”‚             â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>
    â”‚              â”‚             â”‚ Document record created             â”‚
    â”‚              â”‚             â”‚            â”‚         â”‚            â”‚
    â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚ WebSocket: Complete       â”‚            â”‚         â”‚            â”‚
    â”‚ {download_url}            â”‚            â”‚         â”‚            â”‚
    â”‚              â”‚             â”‚            â”‚         â”‚            â”‚
```

**Document Generation Steps:**

1. **Query Lecture Data** - Get lecture metadata from PostgreSQL
2. **Retrieve Content** - Query ChromaDB for all text chunks
3. **Summarize** - Use Ollama to create condensed summaries
4. **Load Figures** - Load cropped diagram images from storage
5. **Format Document** - Use python-docx to create 2-column layout:
   - Set margins to 0.5 inches
   - Create 2 columns
   - Set font to Arial 9pt (body), 11pt bold (headings)
   - Insert text content
   - Insert figures at appropriate locations (3.2" width)
6. **Save File** - Save to `/data/generated/123/456/cheat_sheet.docx`
7. **Create Database Record** - Insert into generated_documents table
8. **Notify Client** - Send download URL via WebSocket

---

## 6. Quiz Generation Flow

### 6.1 Generate Quiz

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Client â”‚  â”‚ChromaDBâ”‚  â”‚PostgreSQLâ”‚ â”‚Ollamaâ”‚  â”‚ Worker â”‚
â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”¬â”€â”€â”€â”˜  â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
    â”‚            â”‚            â”‚           â”‚           â”‚
    â”‚ POST /documents/generate           â”‚           â”‚
    â”‚ {lecture_id, doc_type=quiz,        â”‚           â”‚
    â”‚  options: {num_questions: 10}}     â”‚           â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
    â”‚            â”‚            â”‚           â”‚           â”‚
    â”‚            â”‚            â”‚           â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”
    â”‚            â”‚            â”‚           â”‚  â”‚ 1. Retrieve   â”‚
    â”‚            â”‚            â”‚           â”‚  â”‚    content    â”‚
    â”‚            â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚            â”‚ Query all chunks           â”‚               â”‚
    â”‚            â”‚            â”‚           â”‚  â”‚               â”‚
    â”‚            â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>
    â”‚            â”‚ Chunks     â”‚           â”‚  â”‚               â”‚
    â”‚            â”‚            â”‚           â”‚  â”‚ 2. Extract    â”‚
    â”‚            â”‚            â”‚           â”‚  â”‚    key conceptsâ”‚
    â”‚            â”‚            â”‚           â”‚  â”‚               â”‚
    â”‚            â”‚            â”‚           â”‚<â”€â”¤               â”‚
    â”‚            â”‚            â”‚           â”‚  Prompt: extract â”‚
    â”‚            â”‚            â”‚           â”‚  key concepts    â”‚
    â”‚            â”‚            â”‚           â”‚  â”‚               â”‚
    â”‚            â”‚            â”‚           â”‚ â”€>               â”‚
    â”‚            â”‚            â”‚           â”‚  Concepts list   â”‚
    â”‚            â”‚            â”‚           â”‚  â”‚               â”‚
    â”‚            â”‚            â”‚           â”‚  â”‚ 3. Generate   â”‚
    â”‚            â”‚            â”‚           â”‚  â”‚    questions  â”‚
    â”‚            â”‚            â”‚           â”‚<â”€â”¤               â”‚
    â”‚            â”‚            â”‚           â”‚  Prompt: create  â”‚
    â”‚            â”‚            â”‚           â”‚  MCQ questions   â”‚
    â”‚            â”‚            â”‚           â”‚  â”‚               â”‚
    â”‚            â”‚            â”‚           â”‚ â”€>               â”‚
    â”‚            â”‚            â”‚           â”‚  Questions JSON  â”‚
    â”‚            â”‚            â”‚           â”‚  â”‚               â”‚
    â”‚            â”‚            â”‚           â”‚  â”‚ 4. Format PDF â”‚
    â”‚            â”‚            â”‚           â”‚  â”‚    using fpdf â”‚
    â”‚            â”‚            â”‚           â”‚  â”‚               â”‚
    â”‚            â”‚            â”‚           â”‚  â”‚ 5. Save file  â”‚
    â”‚            â”‚            â”‚           â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
    â”‚            â”‚            â”‚           â”‚           â”‚
    â”‚            â”‚            â”‚ INSERT generated_document    â”‚
    â”‚            â”‚            â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚            â”‚            â”‚           â”‚           â”‚
    â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚ 200 OK {download_url}  â”‚           â”‚           â”‚
    â”‚            â”‚            â”‚           â”‚           â”‚
```

**Quiz Generation Steps:**

1. **Retrieve Content** - Get all text chunks from ChromaDB for lecture
2. **Extract Key Concepts** - Use Ollama to identify main topics
3. **Generate Questions** - Prompt LLM to create MCQ questions with:
   - Question text
   - 4 answer options (A, B, C, D)
   - Correct answer
   - Explanation
4. **Format as PDF** - Use fpdf to create quiz PDF:
   - Question numbering
   - Multiple choice options
   - Optional answer key section
5. **Save and Return** - Save PDF and return download URL

---

## 7. Flashcard & Spaced Repetition Flow

### 7.1 Generate Flashcards

```
Worker generates flashcards from lecture content:

1. Query ChromaDB for lecture chunks
2. Identify Q&A pairs or key concepts
3. Use Ollama to generate:
   - Front: Question/prompt
   - Back: Answer/explanation
4. Insert flashcards into PostgreSQL with SM-2 defaults:
   - difficulty = 0
   - interval = 0
   - repetitions = 0
   - ease_factor = 2.5
   - next_review = NOW()
```

### 7.2 Review Flashcard

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Client â”‚  â”‚API Gatewayâ”‚ â”‚PostgreSQLâ”‚
â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
    â”‚              â”‚            â”‚
    â”‚ GET /flashcards/due       â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚            â”‚
    â”‚              â”‚            â”‚
    â”‚              â”‚ SELECT flashcards WHERE next_review <= NOW()
    â”‚              â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
    â”‚              â”‚            â”‚
    â”‚              â”‚ <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚              â”‚ Due cards  â”‚
    â”‚              â”‚            â”‚
    â”‚ <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤            â”‚
    â”‚ [flashcards] â”‚            â”‚
    â”‚              â”‚            â”‚
    â”‚ User reviews card         â”‚
    â”‚ POST /flashcards/123/review
    â”‚ {quality: 4}  # 0-5 ratingâ”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚            â”‚
    â”‚              â”‚            â”‚
    â”‚              â”‚ Calculate SM-2 algorithm:
    â”‚              â”‚ - Update ease_factor
    â”‚              â”‚ - Calculate new interval
    â”‚              â”‚ - Set next_review date
    â”‚              â”‚            â”‚
    â”‚              â”‚ UPDATE flashcard
    â”‚              â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
    â”‚              â”‚            â”‚
    â”‚ <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤            â”‚
    â”‚ {next_review}â”‚            â”‚
    â”‚              â”‚            â”‚
```

**SM-2 Algorithm:**

```python
def update_flashcard(quality: int, card: Flashcard) -> Flashcard:
    """
    quality: 0-5 (0=total blackout, 5=perfect recall)
    """
    if quality >= 3:
        # Correct response
        if card.repetitions == 0:
            card.interval = 1
        elif card.repetitions == 1:
            card.interval = 6
        else:
            card.interval = round(card.interval * card.ease_factor)
        
        card.repetitions += 1
    else:
        # Incorrect response - reset
        card.repetitions = 0
        card.interval = 1
    
    # Update ease factor
    card.ease_factor = card.ease_factor + (0.1 - (5 - quality) * (0.08 + (5 - quality) * 0.02))
    
    if card.ease_factor < 1.3:
        card.ease_factor = 1.3
    
    # Set next review date
    card.next_review = datetime.now() + timedelta(days=card.interval)
    
    return card
```

---

## 8. Share Link Flow

### 8.1 Create Share Link

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Client â”‚  â”‚API Gatewayâ”‚ â”‚PostgreSQLâ”‚
â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
    â”‚              â”‚            â”‚
    â”‚ POST /share/create        â”‚
    â”‚ {lecture_id, password, expires_in: 7}
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚            â”‚
    â”‚              â”‚            â”‚
    â”‚              â”‚ Generate unique code (8 chars)
    â”‚              â”‚ Hash password (if provided)
    â”‚              â”‚            â”‚
    â”‚              â”‚ INSERT share_link
    â”‚              â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
    â”‚              â”‚            â”‚
    â”‚              â”‚ <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚              â”‚ Link createdâ”‚
    â”‚              â”‚            â”‚
    â”‚ <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤            â”‚
    â”‚ {link_code, url}          â”‚
    â”‚ https://app/share/abc12345â”‚
    â”‚              â”‚            â”‚
```

### 8.2 Access Shared Content

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Visitor â”‚  â”‚API Gatewayâ”‚ â”‚PostgreSQLâ”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
     â”‚              â”‚            â”‚
     â”‚ GET /share/abc12345       â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚            â”‚
     â”‚              â”‚            â”‚
     â”‚              â”‚ SELECT share_link WHERE code=...
     â”‚              â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
     â”‚              â”‚            â”‚
     â”‚              â”‚ <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚              â”‚ Link detailsâ”‚
     â”‚              â”‚            â”‚
     â”‚              â”‚ Validate:  â”‚
     â”‚              â”‚ - is_activeâ”‚
     â”‚              â”‚ - not expired
     â”‚              â”‚ - view_count < max_views
     â”‚              â”‚            â”‚
     â”‚              â”‚ IF password_protected:
     â”‚              â”‚            â”‚
     â”‚ <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤            â”‚
     â”‚ 401 Password Required     â”‚
     â”‚              â”‚            â”‚
     â”‚ POST /share/abc12345/verify
     â”‚ {password}   â”‚            â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚            â”‚
     â”‚              â”‚            â”‚
     â”‚              â”‚ Verify password hash
     â”‚              â”‚            â”‚
     â”‚              â”‚ UPDATE view_count++, last_accessed
     â”‚              â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
     â”‚              â”‚            â”‚
     â”‚ <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤            â”‚
     â”‚ Lecture/document content  â”‚
     â”‚              â”‚            â”‚
```

---

## 9. Analytics & Progress Tracking

### 9.1 Study Session Tracking

```
Every study activity is tracked:

1. User starts quiz/flashcards/chat
   â†’ INSERT study_session (started_at)

2. User completes activity
   â†’ UPDATE study_session (ended_at, score, items_completed)

3. Analytics dashboard queries:
   - SELECT by date range
   - GROUP BY subject_id
   - Calculate averages, totals
```

### 9.2 Dashboard Analytics Query

```sql
-- Total study time per subject (last 30 days)
SELECT 
    s.name as subject_name,
    COUNT(ss.id) as session_count,
    SUM(ss.duration) as total_minutes,
    AVG(ss.score) as avg_score
FROM study_sessions ss
JOIN subjects s ON ss.subject_id = s.id
WHERE ss.user_id = 123
  AND ss.started_at >= NOW() - INTERVAL '30 days'
GROUP BY s.id, s.name
ORDER BY total_minutes DESC;

-- Weak areas (low quiz scores)
SELECT 
    l.name as lecture_name,
    AVG(ss.score) as avg_score,
    COUNT(ss.id) as attempts
FROM study_sessions ss
JOIN lectures l ON ss.lecture_id = l.id
WHERE ss.user_id = 123
  AND ss.session_type = 'quiz'
GROUP BY l.id, l.name
HAVING AVG(ss.score) < 70
ORDER BY avg_score ASC;
```

---

## 10. Error Handling Flows

### 10.1 Processing Failure

```
If lecture processing fails:

1. Worker catches exception
2. UPDATE lecture status='failed', error_message='...'
3. Publish failure message to Redis
4. WebSocket notifies client
5. Client displays error with retry option
6. User can retry â†’ creates new task
```

### 10.2 Rate Limiting

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”
â”‚ Client â”‚  â”‚API Gatewayâ”‚ â”‚Redisâ”‚
â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”¬â”€â”€â”˜
    â”‚              â”‚          â”‚
    â”‚ POST /chat   â”‚          â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚          â”‚
    â”‚              â”‚          â”‚
    â”‚              â”‚ Check rate limit
    â”‚              â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
    â”‚              â”‚ INCR ratelimit:user:123:chat:minute
    â”‚              â”‚          â”‚
    â”‚              â”‚ <â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚              â”‚ Count=11 â”‚
    â”‚              â”‚          â”‚
    â”‚              â”‚ IF count > 10:
    â”‚ <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤          â”‚
    â”‚ 429 Too Many Requests   â”‚
    â”‚ {retry_after: 45}       â”‚
    â”‚              â”‚          â”‚
```

Rate limits:
- Chat: 10 requests/minute
- Document generation: 5 requests/hour
- File upload: 10 files/hour

---

## 11. Cleanup & Maintenance Flows

### 11.1 Automatic Cleanup (Celery Beat)

```
Scheduled tasks run periodically:

Daily (01:00 AM):
- Delete expired share links
- Archive old study sessions (>1 year)
- Vacuum database

Weekly (Sunday 02:00 AM):
- Generate user analytics summaries
- Cleanup orphaned files

Monthly:
- Database reindexing
- Full backup
```

### 11.2 Manual Cleanup Actions

```
User can manually:

1. Delete subject â†’ CASCADE deletes:
   - All lectures in subject
   - All generated documents
   - All flashcards
   - ChromaDB collection
   - Files from /data/uploads and /data/generated

2. Clear memory â†’ Deletes:
   - ChromaDB embeddings for lecture
   - Keeps original files and database records
```

---

This completes the action flow documentation. Each flow shows the complete journey of data through the system from user action to backend processing to response.
